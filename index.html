<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taqwa Guide | Final Pro 2026</title>
    
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; script-src 'self' 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https://generativelanguage.googleapis.com https://api.aladhan.com;">

    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="cordova.js"></script>

    <style>
        :root { 
            --p: #064e3b; --a: #d97706; --bg: #fdfbf7; 
            --danger: #dc2626; --user-msg: #e1ffc7; --ai-msg: #ffffff; 
        }
        
        body { font-family: 'Hind Siliguri', sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 85px; color: #1f2937; overflow-x: hidden; }
        
        /* ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® */
        .header { background: var(--p); color: white; padding: 20px 15px; border-radius: 0 0 30px 30px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center; }
        .live-clock { font-size: 32px; font-weight: 700; margin: 5px 0; font-family: 'Courier New', monospace; letter-spacing: 2px; }
        .current-waqt-box { background: rgba(255,255,255,0.15); padding: 15px; border-radius: 20px; margin-top: 10px; border: 1px solid rgba(255,255,255,0.2); }
        .waqt-timer-big { font-size: 26px; font-weight: 700; color: #fbbf24; }

        .tab-content { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
        .active-tab { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü (‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶∞) ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶´‡ßá‡¶∏ */
        #chat-window { height: 380px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 15px; background: #f8fafc; border-radius: 20px; border: 1px solid #e2e8f0; margin-bottom: 15px; }
        .bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.6; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .user-bubble { align-self: flex-end; background: var(--user-msg); border-bottom-right-radius: 2px; color: #064e3b; border: 1px solid #c3e6cb; }
        .ai-bubble { align-self: flex-start; background: var(--ai-msg); border-bottom-left-radius: 2px; border: 1px solid #edf2f7; }
        
        .chat-input-area { display: flex; gap: 10px; background: white; padding: 12px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: sticky; bottom: 5px; }
        .chat-input-area input { flex: 1; border: 1px solid #e2e8f0; border-radius: 15px; padding: 12px; font-family: inherit; outline: none; }
        .send-btn { background: var(--p); color: white; border: none; padding: 0 20px; border-radius: 15px; font-weight: bold; cursor: pointer; }

        /* ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶ì ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ */
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); margin-bottom: 15px; border-top: 5px solid var(--p); }
        .prayer-row { padding: 10px 0; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; }
        .sub-nav { display: flex; gap: 8px; margin-bottom: 15px; }
        .sub-nav-btn { flex: 1; padding: 10px; border-radius: 10px; border: 2px solid var(--p); background: white; color: var(--p); font-weight: bold; }
        .sub-nav-btn.active { background: var(--p); color: white; }
        .path-item { background: white; border-left: 5px solid var(--p); padding: 15px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 14px; }

        /* ‡¶¨‡¶ü‡¶Æ ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.08); border-radius: 20px 20px 0 0; }
        .nav-item { border: none; background: none; color: #94a3b8; font-family: inherit; font-size: 12px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--p); transform: translateY(-5px); }
    </style>
</head>
<body>

<div id="setup-screen" style="display: none; position: fixed; inset: 0; background: var(--p); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 30px; text-align: center;">
    <h1>‡¶§‡¶æ‡¶ï‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡¶æ‡¶á‡¶°</h1>
    <p>‡¶ú‡ßá‡¶≤‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</p>
    <select id="district-select" style="width: 100%; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
        <option value="Dhaka">‡¶¢‡¶æ‡¶ï‡¶æ</option><option value="Munshiganj">‡¶Æ‡ßÅ‡¶®‡ßç‡¶∏‡ßÄ‡¶ó‡¶û‡ßç‡¶ú</option><option value="Chittagong">‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ</option><option value="Sylhet">‡¶∏‡¶ø‡¶≤‡ßá‡¶ü</option><option value="Rajshahi">‡¶∞‡¶æ‡¶ú‡¶∂‡¶æ‡¶π‡ßÄ</option><option value="Khulna">‡¶ñ‡ßÅ‡¶≤‡¶®‡¶æ</option><option value="Barisal">‡¶¨‡¶∞‡¶ø‡¶∂‡¶æ‡¶≤</option><option value="Rangpur">‡¶∞‡¶Ç‡¶™‡ßÅ‡¶∞</option>
    </select>
    <button onclick="saveSetup()" class="send-btn" style="background: white; color: var(--p); padding: 15px; width: 100%;">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
</div>

<div class="header">
    <div style="display: flex; justify-content: space-between; font-size: 12px; opacity: 0.9;">
        <div id="hijri-date">üåô ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
        <div id="eng-date">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ...</div>
    </div>
    <div class="live-clock" id="clock">00:00:00 AM</div>
    <div class="current-waqt-box">
        <div id="waqt-name" style="font-weight: bold;">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ì‡¶Ø‡¶º‡¶æ‡¶ï‡ßç‡¶§</div>
        <div id="waqt-range" style="font-size: 12px; margin-bottom: 5px;">--:-- | --:--</div>
        <div class="waqt-timer-big" id="waqt-countdown">00:00:00</div>
    </div>
</div>

<div id="home-tab" class="tab-content active-tab">
    <div id="displayMosqueList"></div>
</div>

<div id="daily-tab" class="tab-content">
    <div class="sub-nav">
        <button id="btn-hadith" class="sub-nav-btn active" onclick="showPathContent('hadith')">‡¶π‡¶æ‡¶¶‡¶ø‡¶∏</button>
        <button id="btn-dua" class="sub-nav-btn" onclick="showPathContent('dua')">‡¶¶‡ßã‡¶Ø‡¶º‡¶æ ‡¶ì ‡¶Ü‡¶Æ‡¶≤</button>
    </div>
    <div id="path-list-container">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
</div>

<div id="mentor-tab" class="tab-content">
    <div id="chat-window">
        <div class="bubble ai-bubble">‡¶Ü‡¶∏‡¶∏‡¶æ‡¶≤‡¶æ‡¶Æ‡ßÅ ‡¶Ü‡¶≤‡¶æ‡¶á‡¶ï‡ßÅ‡¶Æ! ‡¶Ü‡¶Æ‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶æ‡¶ï‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶∞‡•§ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡¶ø‡¶§ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§</div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="m-input" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ü‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
        <button class="send-btn" id="mentor-btn" onclick="askMentor()">‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
    </div>
</div>

<div id="waqt-tab" class="tab-content">
    <div class="card">
        <h3 id="location-display" style="color:var(--p); margin:0 0 15px 0;">üìç ‡¶ú‡ßá‡¶≤‡¶æ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶∏‡¶Æ‡¶Ø‡¶º</h3>
        <div id="daily-times-list"></div>
    </div>
</div>

<div id="settings-tab" class="tab-content">
    <div class="card">
        <h3>‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
        <input type="text" id="mName" placeholder="‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ..." style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd; margin-bottom: 10px;">
        <button class="send-btn" style="width:100%; padding: 12px;" onclick="addMosque()">‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button onclick="localStorage.clear(); location.reload();" style="margin-top:15px; background:none; border:1px solid #ccc; border-radius:10px; padding:10px; width:100%; cursor:pointer;">Reset App</button>
    </div>
    <div id="editMosqueList"></div>
</div>

<div class="nav-bar">
    <button class="nav-item active" onclick="switchTab('home-tab', this)">‡¶®‡¶æ‡¶Æ‡¶æ‡¶Ø</button>
    <button class="nav-item" onclick="switchTab('daily-tab', this)">‡¶™‡¶æ‡¶•‡ßá‡¶Ø‡¶º</button>
    <button class="nav-item" onclick="switchTab('mentor-tab', this)">‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂</button>
    <button class="nav-item" onclick="switchTab('waqt-tab', this)">‡¶ì‡¶Ø‡¶º‡¶æ‡¶ï‡ßç‡¶§</button>
    <button class="nav-item" onclick="switchTab('settings-tab', this)">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
</div>

<script>
    const KEY = 'AIzaSyD2xk4MyupZ9Vw5yvANSbplqW_VmSFfC8I'; 
    let mosques = JSON.parse(localStorage.getItem('mosques')) || [];
    let userDistrict = localStorage.getItem('userDistrict');
    let pData = null;

    function initApp() {
        if (!userDistrict) { document.getElementById('setup-screen').style.display = 'flex'; } 
        else { document.getElementById('setup-screen').style.display = 'none'; fetchData(); }
        // ‡¶®‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶®
        if (window.cordova && cordova.plugins.notification.local) {
            cordova.plugins.notification.local.requestPermission(function(granted) {});
        }
    }
    document.addEventListener("deviceready", initApp, false);
    window.onload = () => { if(!window.cordova) initApp(); };

    function saveSetup() {
        localStorage.setItem('userDistrict', document.getElementById('district-select').value);
        location.reload();
    }

    async function fetchData() {
        try {
            const res = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${userDistrict}&country=Bangladesh&method=1`);
            const json = await res.json();
            pData = json.data.timings;
            document.getElementById('location-display').innerText = `üìç ‡¶ú‡ßá‡¶≤‡¶æ: ${userDistrict}`;
            startSystem();
            fetchDailyContent();
        } catch (e) { console.error(e); }
    }

    function startSystem() {
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('en-US', { hour12: true });
            document.getElementById('eng-date').innerText = now.toLocaleDateString('bn-BD', {day:'numeric', month:'long'});
            try {
                const hijri = new Intl.DateTimeFormat('bn-BD-u-ca-islamic-uma-nu-latn', {day:'numeric', month:'long', year:'numeric'}).format(now);
                document.getElementById('hijri-date').innerText = `üåô ${hijri}`;
            } catch(e) { }
            updateHeaderWaqt(now);
            renderWaqtTab(now);
            renderHomeMosques(now);
        }, 1000);
    }

    // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶ú‡¶ø‡¶™‡¶ø‡¶ü‡¶ø ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    async function askMentor() {
        const input = document.getElementById('m-input');
        const text = input.value.trim();
        const win = document.getElementById('chat-window');
        const btn = document.getElementById('mentor-btn');

        if (!text) return;

        addChatBubble(text, 'user-bubble');
        input.value = '';
        btn.disabled = true;

        const aiLoading = addChatBubble('‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶∞ ‡¶ö‡¶ø‡¶®‡ßç‡¶§‡¶æ ‡¶ï‡¶∞‡¶õ‡ßá‡¶®...', 'ai-bubble');

        try {
            // ‡ß®‡ß¶‡ß®‡ß¨ ‡¶∏‡¶æ‡¶≤‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨‡¶≤ ‡¶è‡¶®‡ßç‡¶°‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶ì ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶ï‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
            const prompt = `‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶è‡¶ï‡¶ú‡¶® ‡¶¨‡¶ø‡¶ú‡ßç‡¶û ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶∞‡•§ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤‡ßá ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™‡ßá ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶ì ‡¶π‡¶æ‡¶¶‡¶ø‡¶∏‡ßá‡¶∞ ‡¶Ü‡¶≤‡ßã‡¶ï‡ßá ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡¶æ‡¶ì‡•§ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: ${text}`;
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await resp.json();
            const reply = data.candidates[0].content.parts[0].text;
            aiLoading.innerHTML = reply.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        } catch (e) {
            aiLoading.innerText = "‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶¨‡¶æ ‡¶è‡¶™‡¶ø‡¶Ü‡¶á ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§";
        } finally {
            btn.disabled = false;
            win.scrollTop = win.scrollHeight;
        }
    }

    function addChatBubble(text, className) {
        const div = document.createElement('div');
        div.className = 'bubble ' + className;
        div.innerHTML = text.replace(/\n/g, '<br>');
        const win = document.getElementById('chat-window');
        win.appendChild(div);
        win.scrollTop = win.scrollHeight;
        return div;
    }

    // ‡¶™‡¶™‡¶Ü‡¶™ ‡¶®‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® (High Priority with Sound)
    function scheduleOfflineNotify() {
        if (window.cordova && cordova.plugins.notification.local) {
            cordova.plugins.notification.local.cancelAll();
            mosques.forEach((m, mIdx) => {
                ['‡¶´‡¶ú‡¶∞', '‡¶ú‡ßã‡¶π‡¶∞', '‡¶Ü‡¶∏‡¶∞', '‡¶Æ‡¶æ‡¶ó‡¶∞‡¶ø‡¶¨', '‡¶è‡¶∂‡¶æ'].forEach((prayer, pIdx) => {
                    if (m.times[prayer]) {
                        const [h, min] = m.times[prayer].split(':').map(Number);
                        let jTime = new Date(); jTime.setHours(h, min, 0, 0);
                        if (jTime > new Date()) {
                            cordova.plugins.notification.local.schedule({
                                id: mIdx * 10 + pIdx,
                                title: prayer + " ‡¶ú‡¶æ‡¶Æ‡¶æ‡¶§ - " + m.name,
                                text: "‡¶ú‡¶æ‡¶Æ‡¶æ‡¶Ü‡¶§ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶§‡ßá ‡ßß‡ß¶ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø‡•§ ‡¶®‡¶æ‡¶Æ‡¶æ‡¶Ø‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ø ‡¶®‡¶ø‡¶®‡•§",
                                at: new Date(jTime.getTime() - 10 * 60000),
                                priority: 2, sound: 'res://platform_default', foreground: true, vibrate: true, lockscreen: true
                            });
                        }
                    }
                });
            });
        }
    }

    // ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶π‡¶æ‡¶¶‡¶ø‡¶∏ ‡¶ì ‡¶¶‡ßã‡ßü‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
    async function fetchDailyContent() {
        const today = new Date().toDateString();
        const saved = JSON.parse(localStorage.getItem('pathData'));
        if (saved && saved.date === today) { showPathContent('hadith'); return; }
        try {
            const prompt = "Give me 5 Sahih Hadiths and 5 Islamic Duas in Bengali. Format each line starting with [H] for Hadith and [D] for Dua.";
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${KEY}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await resp.json();
            const raw = data.candidates[0].content.parts[0].text;
            const lines = raw.split('\n');
            const h = lines.filter(l => l.includes('[H]')).map(l => l.replace('[H]', '').trim());
            const d = lines.filter(l => l.includes('[D]')).map(l => l.replace('[D]', '').trim());
            localStorage.setItem('pathData', JSON.stringify({ date: today, hadith: h, dua: d }));
            showPathContent('hadith');
        } catch (e) { document.getElementById('path-list-container').innerText = "‡¶™‡¶æ‡¶•‡ßá‡ßü ‡¶≤‡ßã‡¶° ‡¶è‡¶∞‡¶∞!"; }
    }

    function showPathContent(type) {
        const saved = JSON.parse(localStorage.getItem('pathData')); if (!saved) return;
        document.querySelectorAll('.sub-nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + type).classList.add('active');
        const list = type === 'hadith' ? saved.hadith : saved.dua;
        document.getElementById('path-list-container').innerHTML = list.map(i => `<div class="path-item">${i}</div>`).join('');
    }

    // ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶ì ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï
    function updateHeaderWaqt(now) {
        if(!pData) return;
        const timings = [{n:'‡¶´‡¶ú‡¶∞',s:pData.Fajr,e:pData.Sunrise},{n:'‡¶ú‡ßã‡¶π‡¶∞',s:pData.Dhuhr,e:pData.Asr},{n:'‡¶Ü‡¶∏‡¶∞',s:pData.Asr,e:pData.Maghrib},{n:'‡¶Æ‡¶æ‡¶ó‡¶∞‡¶ø‡¶¨',s:pData.Maghrib,e:pData.Isha},{n:'‡¶è‡¶∂‡¶æ',s:pData.Isha,e:pData.Fajr}];
        let current = null;
        for (let i=0; i<timings.length; i++) {
            let s = timeToDate(timings[i].s); let e = timeToDate(timings[i].e);
            if (timings[i].n==='‡¶è‡¶∂‡¶æ' && now < timeToDate(pData.Fajr)) s.setDate(s.getDate()-1);
            if (timings[i].n==='‡¶è‡¶∂‡¶æ' && e<s) e.setDate(e.getDate()+1);
            if (now >= s && now < e) { current=timings[i]; break; }
        }
        if (current) {
            document.getElementById('waqt-name').innerText = `‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ì‡¶Ø‡¶º‡¶æ‡¶ï‡ßç‡¶§: ${current.n}`;
            document.getElementById('waqt-range').innerText = `${formatTo12Hr(current.s)} - ${formatTo12Hr(current.e)}`;
            let et = timeToDate(current.e); if(et < now) et.setDate(et.getDate()+1);
            document.getElementById('waqt-countdown').innerText = formatTimer(et-now);
        }
    }

    function renderWaqtTab(now) {
        if(!pData) return;
        document.getElementById('daily-times-list').innerHTML = ['Fajr','Dhuhr','Asr','Maghrib','Isha'].map(k => `<div class="prayer-row"><b>${k==='Fajr'?'‡¶´‡¶ú‡¶∞':k==='Dhuhr'?'‡¶ú‡ßã‡¶π‡¶∞':k==='Asr'?'‡¶Ü‡¶∏‡¶∞':k==='Maghrib'?'‡¶Æ‡¶æ‡¶ó‡¶∞‡¶ø‡¶¨':'‡¶è‡¶∂‡¶æ'}</b> <span>${formatTo12Hr(pData[k])}</span></div>`).join('');
    }

    function renderHomeMosques(now) {
        document.getElementById('displayMosqueList').innerHTML = mosques.map(m => {
            let h = `<div class="card"><h3>üïå ${m.name}</h3>`;
            for(let p in m.times) {
                let [hh,mm]=m.times[p].split(':').map(Number); let pt=new Date(); pt.setHours(hh,mm,0,0);
                let diff = pt-now; let st = (diff<=0 && diff>-1200000) ? "<b style='color:red'>‡¶ö‡¶≤‡¶Æ‡¶æ‡¶®</b>" : (diff>0 ? formatTimer(diff) : "<span style='color:#999'>‡¶∂‡ßá‡¶∑</span>");
                h += `<div class="prayer-row"><span>${p}</span> <span>${formatTo12Hr(m.times[p])} <small>(${st})</small></span></div>`;
            }
            return h + `</div>`;
        }).join('') || "<p style='text-align:center; padding:20px;'>‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</p>";
    }

    function timeToDate(t) { const [h,m]=t.split(':'); const d=new Date(); d.setHours(h,m,0,0); return d; }
    function formatTo12Hr(t) { let [h,m]=t.split(':'); h=parseInt(h); let ap=h>=12?'PM':'AM'; h=h%12||12; return `${h}:${m} ${ap}`; }
    function formatTimer(ms) { let s=Math.floor(ms/1000); let m=Math.floor(s/60); let h=Math.floor(m/60); return `${(h%24).toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
    
    function switchTab(id, el) {
        document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active-tab'));
        document.getElementById(id).classList.add('active-tab');
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        el.classList.add('active');
        if(id==='settings-tab') renderSettings();
    }
    
    function addMosque() {
        const n = document.getElementById('mName').value; if(!n) return;
        mosques.push({id:Date.now(),name:n,times:{'‡¶´‡¶ú‡¶∞':'05:15','‡¶ú‡ßã‡¶π‡¶∞':'13:30','‡¶Ü‡¶∏‡¶∞':'16:45','‡¶Æ‡¶æ‡¶ó‡¶∞‡¶ø‡¶¨':'18:10','‡¶è‡¶∂‡¶æ':'20:00'}});
        localStorage.setItem('mosques', JSON.stringify(mosques)); renderSettings();
        document.getElementById('mName').value=''; scheduleOfflineNotify();
    }
    
    function renderSettings() {
        document.getElementById('editMosqueList').innerHTML = mosques.map(m => `<div class="card"><b>${m.name}</b><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-top:10px;">${Object.keys(m.times).map(p=>`<div><label style="font-size:10px">${p}</label><input type="time" value="${m.times[p]}" onchange="updateMTime(${m.id},'${p}',this.value)"></div>`).join('')}</div><button onclick="delM(${m.id})" style="background:#fee2e2;color:red;border:none;margin-top:10px;padding:8px;border-radius:10px;font-weight:bold;width:100%">‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button></div>`).join('');
    }
    function updateMTime(id,p,v) { mosques.find(m=>m.id===id).times[p]=v; localStorage.setItem('mosques',JSON.stringify(mosques)); scheduleOfflineNotify(); }
    function delM(id) { mosques=mosques.filter(m=>m.id!==id); localStorage.setItem('mosques',JSON.stringify(mosques)); renderSettings(); scheduleOfflineNotify(); }
</script> 
</body>
</html>